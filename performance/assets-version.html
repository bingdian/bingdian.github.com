<!DOCTYPE html>
<html lang="zh-CN"> 
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="On The Way" />
    <meta name="application-name" content="On The Way" />
    <title>前端开发静态文件自动添加版本号解决方案 - On The Way</title>
    <meta name="keywords" content="javascript,css,前端,自动化" />
    <meta name="description" content="" />
    
    <link rel="alternate" type="application/rss+xml" href="/feed.xml" title="On The Way" />
    <link rel="stylesheet" href="/static/style.css?v=6a111" />
    <link rel="apple-touch-icon" href="/static/img/touch-icon.png?v=7c663" />
    <link rel="shortcut icon" href="/static/img/favicon.ico?v=c84f4">
    <link rel="canonical" href="http://wlog.cn/performance/assets-version.html" />
    <!--[if lt IE 9]>
    <script src="/static/js/html5shiv.js?v=fb4e3"></script>
    <![endif]-->
</head>
<body>
<div id="wrapper">   
<header id="header" class="clear">
    <h1>前端开发静态文件自动添加版本号解决方案</h1>
</header><!-- #header -->
<nav id="nav" role="navigation">
    <a id="INDEX" href="/index.html">INDEX</a>
    <a id="TAGS" href="/tag/index.html">TAGS</a>
    <a id="PROJECTS" href="/project.html">PROJECTS</a>
    <a id="ABOUT" href="/about.html?hmsr=link&hmmd=&hmpl=&hmkw=&hmci=">ABOUT</a>
    <a id="LINKS" href="/links.html">LINKS</a>
    <a id="FEED" href="/feed.xml">FEED</a>
</nav><article id="main" class="hentry">
    <div class="post-date">- Posted on <time class="updated" datetime="2013-05-07" pubdate>2013-05-07</time></div>
    <div class="entry-content">
        <p>前端开发中不可避免的会遇到缓存问题，那么如何使给这些静态自动给添加版本号使修改后的内容立即生效呢？下面讲下我找到的两种方法:</p>

<h2 id="toc_0">一、通过获取文件最后修改时间</h2>
<p>原理：通过服务器端语言读取文件最后一次修改修改时间，然后将获取的时间作为版本号。</p>
<p>以php为例：</p>

<pre><code>&lt;?php
    function AutoVersion( $file ) {
        if( file_exists($_SERVER['DOCUMENT_ROOT'].$file) ) {
            $ver = filemtime($_SERVER['DOCUMENT_ROOT'] . $file);
        } else {
            $ver = 1;
        }

        return $file .'v=' .$ver;
    }
?&gt;</code></pre>
<p>使用：</p>

<pre><code>&lt;link rel=&quot;stylesheet&quot; href=&quot;&lt;?=AutoVersion('assets/css/style.css')?&gt;&quot; type=&quot;text/css&quot; /&gt;</code></pre>
<p>如果文件存在，就会生成类似于下面代码：</p>

<pre><code>&lt;link rel=&quot;stylesheet&quot; href=&quot;assets/css/style.css?v=1367936144322&quot; type=&quot;text/css&quot; /&gt;</code></pre>
<p>另外，可以考虑将生成的静态html缓存起来，当静态文件通过svn更新时，能过post-commit hooks 执行脚本，更新缓存。</p>

<h2 id="toc_1">二、使用gruntjs生成版本号</h2>
<p>如果你的项目使用了<a href="http://bingdian.fm/javascript/gruntjs-quick-start.html">gruntjs自动化构建工具</a>，你可以通过安装gruntjs的插件来生成版本号。</p>
<p>原理：gruntjs插件通过获取文件md5值（同一文件的md5值是固定的），将文件的路径和对应md5值生成json在等格式文件，然后通过后台程序读取并处理json文件，以文件的md5值作为文件版本号。</p>
<p><strong>推荐使用插件：</strong></p>
<p>grunt-cachebuster: <a href="https://npmjs.org/package/grunt-cachebuster">npmjs.org/package/grunt-cachebuster</a></p>
<p>这个插件可以指定生成json或php格式文件：</p>
<p>json</p>

<pre><code>{
    &quot;path/css/filename1.css&quot; : &quot;fa6a5a3224d7da66d9e0bdec25f62cf0&quot;,
    &quot;path/css/filename2.css&quot; : &quot;5ba48b6e5a7c4d4930fda256f411e55b&quot;,
    &quot;path/js/filename1.js&quot; : &quot;08e0484db917d5c6d9a64863d38d8524&quot;,
    &quot;path/js/filename2.js&quot; : &quot;acf18f30162b04df1a35ba5cc51fff1a&quot;
}</code></pre>
<p>php</p>

<pre><code>&lt;?php
/**
 * GENERATED FILE, DO NOT EDIT. This file is simply a collection of generated hashes for static assets in
 * the project. It is generated by grunt, see Gruntfile.js for details.
 */
return array(
    'md5' =&gt; array(
        'js/main.js' =&gt; 'ae65552d65cd19ab4f1996c77915ed42',
        'js/vendor/modernizr-2.6.2.min.js' =&gt; 'b8009fa783ea3de3802efcd29d7473d5',
        'img/bg/about.jpg' =&gt; '7e402c1d64f0b00b4ade850f9017556a',
        'crossdomain.xml' =&gt; '625e6c239ea0b5504ce0641b74ec2a3b',
    )
);</code></pre>
<p>当然，你也可以自己定义输出容的格式，具体使用方法见官方文档。</p>
<p>另外，还有其它类似的插件：</p>

<ul>
<li><a href="https://github.com/ktmud/grunt-hashmap">github.com/ktmud/grunt-hashmap</a></li>
<li><a href="https://npmjs.org/package/grunt-hash">npmjs.org/package/grunt-hash</a></li>
<li><a href="https://npmjs.org/package/grunt-assets-versioning">npmjs.org/package/grunt-assets-versioning</a></li>
</ul>
<p>你可以根据你的需求选择你合适的插件，更多的插件可以从<a href="http://gruntjs.com/plugins">gruntjs官方的插库</a>找到。</p>
<p>如果你有更好的方法，欢迎分享。</p>

<h2 id="toc_2">扩展阅读</h2>

<ul>
<li><a href="http://derek.io/blog/2009/auto-versioning-javascript-and-css-files/">derek.io/blog/2009/auto-versioning-javascript-and-css-files/</a></li>
<li><a href="http://www.prestashop.com/forums/topic/136126-auto-versioning-css-files-force-css-refresh/">www.prestashop.com/forums/topic/136126-auto-versioning-css-files-force-css-refresh/</a></li>
</ul>

    </div>
    <div class="entry-meta">
        Posted on<time class="updated" datetime="2013-05-07T22:06:00+08:00" pubdate>
            2013-05-07
        </time>
        <span class="entry-category">Category:<a href="/performance/">Performance</a></span>
        <span class="entry-tags">Tags:
            
                <a href="/tag/javascript/">javascript</a>
            
                ,<a href="/tag/css/">css</a>
            
                ,<a href="/tag/前端/">前端</a>
            
                ,<a href="/tag/自动化/">自动化</a>
            
		</span>
    
        
    </div>
    

    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'bingdian-ontheway';
        var disqus_title = '前端开发静态文件自动添加版本号解决方案';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    
</article><footer id="footer">
    <p class="copyright"><span class="software">Powered by <a href="http://lab.lepture.com/liquidluck/">Felix Felicis</a> 3.8.1, </span><span class="theme">Theme <a href="http://wlog.cn/" rel="nofollow">responsive</a> 0.1 by <a href="http://wlog.cn/">bingdian</a></span></p>
</footer><!-- #footer -->
</div><!-- #wrapper -->

<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-1245097-16']);
_gaq.push(['_trackPageview']);
_gaq.push(['_trackPageLoadTime']);
(function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = 'https://ssl.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?485f7f95a93d05ea9fa28dfad6850c58";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
</body>
</html>